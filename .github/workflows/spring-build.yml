name: build spring

on:
  push:
    branches: ["main"]
    # Publish semver tags as releases.
    tags: ["*"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  CDT_VERSION: "v4.1.0"
  SPRING_VERSION: "v1.0.3"
  LLVM_VERSION: "12"

jobs:
  build-cdt:
    runs-on: macos-latest
    strategy:
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true  # Checkout submodules
          
      - name: Set up environment variables
        run: |
            echo 'export PATH="/opt/homebrew/opt/llvm@11/bin:$PATH"' >> $GITHUB_ENV
            echo 'export LDFLAGS="-L/opt/homebrew/opt/llvm@11/lib -Wl,-rpath,/opt/homebrew/opt/llvm@11/lib"' >> $GITHUB_ENV
            echo 'export CPPFLAGS="-I/opt/homebrew/opt/llvm@11/include"' >> $GITHUB_ENV
            echo 'export PATH="/opt/homebrew/opt/binutils/bin:$PATH"' >> $GITHUB_ENV
            echo 'export LDFLAGS="$LDFLAGS -L/opt/homebrew/opt/binutils/lib"' >> $GITHUB_ENV
            echo 'export CPPFLAGS="$CPPFLAGS -I/opt/homebrew/opt/binutils/include"' >> $GITHUB_ENV
            echo 'export LDFLAGS="$LDFLAGS -L/opt/homebrew/opt/zlib/lib"' >> $GITHUB_ENV
            echo 'export CPPFLAGS="$CPPFLAGS -I/opt/homebrew/opt/zlib/include"' >> $GITHUB_ENV
            echo 'export PKG_CONFIG_PATH="/opt/homebrew/opt/zlib/lib/pkgconfig"' >> $GITHUB_ENV
            echo 'export PATH="/opt/homebrew/opt/bzip2/bin:$PATH"' >> $GITHUB_ENV
            echo 'export LDFLAGS="$LDFLAGS -L/opt/homebrew/opt/bzip2/lib"' >> $GITHUB_ENV
            echo 'export CPPFLAGS="$CPPFLAGS -I/opt/homebrew/opt/bzip2/include"' >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          brew update
          brew tap huangyangcong/llvm
          brew upgrade cmake
          #huangyangcong/llvm/llvm@11
          brew install llvm@${{ env.LLVM_VERSION }} ninja gcc@11 automake libtool boost doxygen pyenv binutils zlib bzip2
          brew --prefix llvm@${{ env.LLVM_VERSION }}
          brew --prefix gcc@11
          brew link llvm@${{ env.LLVM_VERSION }}
          ls /opt/homebrew/opt/llvm@${{ env.LLVM_VERSION }}/bin
          ls /opt/homebrew/opt/gcc@11/bin

      - name: Clone & build spring
        run: |
          git clone -b release/1.0 --single-branch https://github.com/AntelopeIO/spring.git
          cd spring
          git checkout ${{ env.SPRING_VERSION }}
          git pull origin ${{ env.SPRING_VERSION }}
          git submodule update --init --recursive

          mkdir -p spring_build/packages
          cd spring_build
          echo "BUILDING SPRING FROM v1.0.3"
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=/opt/homebrew/opt/llvm@${{ env.LLVM_VERSION }}/bin/clang-${{ env.LLVM_VERSION }} -DCMAKE_CXX_COMPILER=/opt/homebrew/opt/llvm@${{ env.LLVM_VERSION }}/bin/clang++ -DCMAKE_PREFIX_PATH="/opt/homebrew/opt/llvm@${{ env.LLVM_VERSION }};/opt/homebrew/opt/gcc@11" ../
          echo "FINISHED CMAKE SPRING"
          make -j $(sysctl -n hw.ncpu) package
          echo "FINISHED BUILDING SPRING"

          # Export spring_DIR for later use
          echo "spring_DIR=$(pwd)/lib/cmake/spring" >> $GITHUB_ENV

      - name: Copy output
        run: |
          mkdir -p output
          mv ${{ env.spring_DIR }}/*.deb output/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-artifacts
          path: output/*
